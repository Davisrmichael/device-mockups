<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mockup Maker — iPhone (model-viewer)</title>
<script type="module" src="https://unpkg.com/@google/model-viewer@3.3.0/dist/model-viewer.min.js"></script>
<style>
  :root{--bg:#eef1f4;--panel:#fff;--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--btn:#111827;--radius:16px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink);
       display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06);
         padding:16px;display:flex;flex-direction:column;gap:16px;height:calc(100vh - 32px);position:sticky;top:16px}
  h1{font-size:18px;margin:0;display:flex;gap:8px;align-items:center}
  .pill{font-size:12px;background:#e0ecff;color:#2563eb;padding:4px 8px;border-radius:999px;font-weight:700}
  .section{border-top:1px solid var(--line);padding-top:12px;margin-top:4px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:none;border-radius:10px;padding:10px 12px;background:var(--btn);color:#fff;font-weight:700;cursor:pointer}
  .btn.secondary{background:#e5e7eb;color:#111827}
  .hint{font-size:12px;color:var(--muted)}
  .urlbar{display:flex;gap:8px;width:100%}
  .urlbar input{flex:1;padding:10px;border:1px solid var(--line);border-radius:10px;font-size:14px}
  input[type="range"]{width:100%}
  .stage-outer{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px;display:flex;justify-content:center}
  .stage{width:720px;height:720px;border-radius:12px;overflow:hidden;position:relative;background:#e5e7eb;display:flex;align-items:center;justify-content:center}
  model-viewer{width:720px;height:720px;--poster-color: transparent;}
  .toolbar{display:flex;justify-content:space-between;align-items:center}
  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111827;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;opacity:0;transition:opacity .25s}
  .toast.show{opacity:1}
  label.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <aside class="panel">
    <h1>Mockup Maker <span class="pill">iPhone • model-viewer</span></h1>

    <div class="section">
      <div class="row"><strong>Device</strong></div>
      <div class="hint">Loads <code>iPhone-15-pro-2/iPhone-15.gltf</code> from this repo.</div>
    </div>

    <div class="section">
      <div class="row"><strong>Screen Texture</strong></div>
      <div class="row">
        <button id="chooseImage" class="btn">Choose Image…</button>
        <input id="imageInput" type="file" accept="image/*" style="display:none">
        <label class="small"><input type="checkbox" id="emissiveOn" checked> Bright (emissive)</label>
        <button id="clearImage" class="btn secondary" disabled>Clear</button>
      </div>
      <div class="row" style="width:100%">
        <div style="flex:1"><div class="hint">Zoom</div><input id="zoom" type="range" min="0.5" max="2.0" step="0.01" value="1.0"></div>
        <div style="width:56px;text-align:right" id="zoomVal">1.00×</div>
      </div>
      <div class="row" style="width:100%">
        <div style="flex:1"><div class="hint">Pan X</div><input id="panX" type="range" min="-1" max="1" step="0.01" value="0"></div>
        <div style="width:56px;text-align:right" id="panXVal">0.00</div>
      </div>
      <div class="row" style="width:100%">
        <div style="flex:1"><div class="hint">Pan Y</div><input id="panY" type="range" min="-1" max="1" step="0.01" value="0"></div>
        <div style="width:56px;text-align:right" id="panYVal">0.00</div>
      </div>
      <div class="hint">Targets material named <code>Screen</code>. Image is <b>cover-fit</b> with uniform scale; pan/zoom adjust the crop.</div>
    </div>

    <div class="section">
      <div class="row"><strong>Orientation & Padding</strong></div>
      <div class="row" style="width:100%"><div style="flex:1"><div class="hint">Rotate X (°)</div><input id="rx" type="range" min="-60" max="60" step="1" value="0"></div><div style="width:44px;text-align:right" id="rxVal">0°</div></div>
      <div class="row" style="width:100%"><div style="flex:1"><div class="hint">Rotate Y (°)</div><input id="ry" type="range" min="-180" max="180" step="1" value="0"></div><div style="width:56px;text-align:right" id="ryVal">0°</div></div>
      <div class="row" style="width:100%"><div style="flex:1"><div class="hint">Padding</div><input id="pad" type="range" min="0" max="220" step="2" value="36"></div><div style="width:64px;text-align:right" id="padVal">36px</div></div>
      <div class="row"><button id="frontBtn" class="btn secondary">Front-on</button><button id="resetBtn" class="btn secondary">Reset</button></div>
      <div class="hint">“Front-on” uses a hidden +180° yaw so the slider shows 0° but faces the screen.</div>
    </div>

    <div class="section">
      <div class="row"><strong>Export</strong></div>
      <div class="hint">Exports an exact 720×720 PNG.</div>
      <button id="exportBtn" class="btn">Export PNG</button>
    </div>
  </aside>

  <main>
    <div class="toolbar"><div class="hint">Preview (exact 720×720 export)</div></div>
    <div class="stage-outer">
      <div class="stage">
        <model-viewer id="mv"
          src="iPhone-15-pro-2/iPhone-15.gltf"
          camera-controls
          environment-image="neutral"
          exposure="1.0"
          shadow-intensity="0"
          ar-modes=""
          disable-tap
          interaction-prompt="none"
          tone-mapping="neutral">
        </model-viewer>
      </div>
    </div>
  </main>

  <div id="toast" class="toast"></div>

<script type="module">
const mv = document.getElementById('mv');
const chooseImage = document.getElementById('chooseImage');
const imageInput = document.getElementById('imageInput');
const emissiveOn = document.getElementById('emissiveOn');
const clearImage = document.getElementById('clearImage');
const zoom = document.getElementById('zoom'), panX=document.getElementById('panX'), panY=document.getElementById('panY');
const rx = document.getElementById('rx'), ry=document.getElementById('ry');
const pad = document.getElementById('pad');
const zoomVal=document.getElementById('zoomVal'), panXVal=document.getElementById('panXVal'), panYVal=document.getElementById('panYVal'), rxVal=document.getElementById('rxVal'), ryVal=document.getElementById('ryVal'), padVal=document.getElementById('padVal');
const toast = document.getElementById('toast');

// 720x720 offscreen canvas used for texturing and export
const off = document.createElement('canvas');
off.width = 720; off.height = 720;
const ctx = off.getContext('2d');

let imgBitmap = null; // ImageBitmap of the uploaded image
let screenMat = null;  // cached material named "Screen"

function showToast(msg){
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(()=> toast.classList.remove('show'), 1400);
}

// Camera/padding control
function applyCamera(){
  const theta = parseInt(ry.value,10)||0;  // yaw
  const phi = 90 - (parseInt(rx.value,10)||0); // pitch
  const radius = 2.6 + (parseInt(pad.value,10)||0) * 0.006;
  mv.cameraOrbit = `${theta}deg ${phi}deg ${radius}m`;
  rxVal.textContent = `${rx.value}°`;
  ryVal.textContent = `${ry.value}°`;
  padVal.textContent = `${pad.value}px`;
}
[rx,ry,pad].forEach(el=> el.addEventListener('input', applyCamera));
document.getElementById('frontBtn').addEventListener('click', ()=>{ rx.value=0; ry.value=180; applyCamera(); });
document.getElementById('resetBtn').addEventListener('click', ()=>{ rx.value=0; ry.value=0; pad.value=36; applyCamera(); });

function updateFitLabels(){
  zoomVal.textContent = `${Number(zoom.value).toFixed(2)}×`;
  panXVal.textContent = Number(panX.value).toFixed(2);
  panYVal.textContent = Number(panY.value).toFixed(2);
}
[zoom,panX,panY].forEach(el=> el.addEventListener('input', ()=>{ updateFitLabels(); if(imgBitmap) applyCanvasToScreen(); }));

// Find / cache the Screen material when model loads
mv.addEventListener('load', ()=>{
  const mats = mv.model?.materials || [];
  screenMat = mats.find(m => (m.name||'') === 'Screen') || null;
  if(!screenMat){
    showToast('Screen material not found'); 
  }else{
    showToast('Screen material ready');
  }
});

// Draw the uploaded image into the 720×720 canvas with COVER fit, uniform scale, pan
function drawCoverToCanvas(){
  ctx.clearRect(0,0,off.width,off.height);
  ctx.fillStyle = '#000'; // behind the image
  ctx.fillRect(0,0,off.width,off.height);
  if(!imgBitmap) return;

  const Z = parseFloat(zoom.value) || 1.0;

  // Source size
  const sw = imgBitmap.width;
  const sh = imgBitmap.height;

  // Destination size (square)
  const dw = off.width;
  const dh = off.height;

  // COVER scale (uniform)
  const scale = Math.max(dw/sw, dh/sh) * Z;
  const tw = sw * scale;
  const th = sh * scale;

  // Pan: -1..1 shifts by up to 25% of the overflow region
  const overflowX = Math.max(0, tw - dw);
  const overflowY = Math.max(0, th - dh);
  const px = (parseFloat(panX.value)||0) * 0.5 * overflowX; // amplify a bit (0.5)
  const py = (parseFloat(panY.value)||0) * 0.5 * overflowY;

  const dx = (dw - tw)/2 + px;
  const dy = (dh - th)/2 + py;

  // Flip vertically to match glTF UVs (prevents upside-down)
  ctx.save();
  ctx.translate(0, dh);
  ctx.scale(1, -1);
  ctx.drawImage(imgBitmap, dx, dh - dy - th, tw, th);
  ctx.restore();
}

async function applyCanvasToScreen(){
  if(!screenMat){ showToast('Screen not ready'); return; }
  drawCoverToCanvas();

  try{
    await mv.updateComplete;
    const tex = await mv.createTexture(off); // pass the canvas directly

    // Make sure base shows true colors (white factor, no metal)
    const pbr = screenMat.pbrMetallicRoughness;
    if (pbr?.setBaseColorFactor) pbr.setBaseColorFactor([1,1,1,1]);

    // Apply as base color texture (version-safe)
    if (pbr?.baseColorTexture?.setTexture) {
      pbr.baseColorTexture.setTexture(tex);
    } else if (pbr?.setBaseColorTexture) {
      pbr.setBaseColorTexture(tex);
    }

    // Optionally also emissive
    if (emissiveOn.checked) {
      if (typeof screenMat.setEmissiveTexture === 'function') {
        screenMat.setEmissiveTexture(tex);
      } else if (screenMat.emissiveTexture?.setTexture) {
        screenMat.emissiveTexture.setTexture(tex);
      }
      if (typeof screenMat.setEmissiveFactor === 'function') {
        screenMat.setEmissiveFactor([1,1,1]);
      } else {
        screenMat.emissiveFactor = [1,1,1];
      }
    } else {
      if (typeof screenMat.setEmissiveTexture === 'function') screenMat.setEmissiveTexture(null);
      else if (screenMat.emissiveTexture?.setTexture) screenMat.emissiveTexture.setTexture(null);
      if (typeof screenMat.setEmissiveFactor === 'function') screenMat.setEmissiveFactor([0,0,0]);
      else screenMat.emissiveFactor = [0,0,0];
    }

    // Non-metal, slightly matte
    if (typeof pbr?.setMetallicFactor === 'function') pbr.setMetallicFactor(0.0);
    if (typeof pbr?.setRoughnessFactor === 'function') pbr.setRoughnessFactor(0.9);

    clearImage.disabled = true === false; // keep enabled after set
    clearImage.disabled = false;
    showToast('Image applied');
  }catch(e){
    console.error(e);
    showToast('Failed to apply image');
  }
}

// Image selection
chooseImage.addEventListener('click', ()=> imageInput.click());
imageInput.addEventListener('change', async ()=>{
  const f = imageInput.files?.[0];
  if(!f) return;
  try{
    // Use ImageBitmap for speed and CORS safety
    const blobURL = URL.createObjectURL(f);
    const img = await fetch(blobURL).then(r=>r.blob()).then(createImageBitmap);
    URL.revokeObjectURL(blobURL);
    imgBitmap = img;
    updateFitLabels();
    await applyCanvasToScreen();
  }catch(err){
    console.error(err);
    showToast('Could not read image');
  }
});
clearImage.addEventListener('click', ()=>{
  if(!screenMat) return;
  const pbr = screenMat.pbrMetallicRoughness;
  pbr?.baseColorTexture?.setTexture?.(null);
  if (typeof screenMat.setEmissiveTexture === 'function') screenMat.setEmissiveTexture(null);
  else screenMat.emissiveTexture?.setTexture?.(null);
  if (typeof screenMat.setEmissiveFactor === 'function') screenMat.setEmissiveFactor([0,0,0]);
  else screenMat.emissiveFactor = [0,0,0];
  imgBitmap = null;
  clearImage.disabled = true;
  showToast('Cleared');
});

// Export PNG 720×720
document.getElementById('exportBtn').addEventListener('click', async ()=>{
  try{
    await mv.updateComplete;
    const blob = await mv.toBlob({mimeType:'image/png', quality:1.0, idealAspect:1});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'mockup-720.png';
    a.click();
    URL.revokeObjectURL(a.href);
  }catch(e){
    console.error(e);
    showToast('Export failed');
  }
});

// Init labels & camera
updateFitLabels();
applyCamera();
</script>
</body>
</html>
