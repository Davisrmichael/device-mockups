<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mockup Maker — robust screen swap</title>
<script type="module" src="https://unpkg.com/@google/model-viewer@3.3.0/dist/model-viewer.min.js"></script>
<style>
  :root{--bg:#e9edf1;--panel:#fff;--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--btn:#111827;--radius:16px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink);
       display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06);
         padding:16px;display:flex;flex-direction:column;gap:16px;height:calc(100vh - 32px);position:sticky;top:16px}
  h1{font-size:18px;margin:0;display:flex;gap:8px;align-items:center}
  .pill{font-size:12px;background:#e0ecff;color:#2563eb;padding:4px 8px;border-radius:999px;font-weight:700}
  .section{border-top:1px solid var(--line);padding-top:12px;margin-top:4px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:none;border-radius:10px;padding:10px 12px;background:var(--btn);color:#fff;font-weight:700;cursor:pointer}
  .btn.secondary{background:#e5e7eb;color:#111827}
  .hint{font-size:12px;color:var(--muted)}
  select,input[type="range"]{width:100%}
  .stage-outer{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px;display:flex;justify-content:center}
  .stage{width:720px;height:720px;border-radius:12px;overflow:hidden;position:relative;background:#e5e7eb;display:flex;align-items:center;justify-content:center}
  model-viewer{width:720px;height:720px;--poster-color: transparent;}
  .toolbar{display:flex;justify-content:space-between;align-items:center}
  #banner{display:none;color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;border-radius:8px;padding:8px 10px;font-size:13px}
  code.small{font-size:11px}
</style>
</head>
<body>
  <aside class="panel">
    <h1>Mockup Maker <span class="pill">auto-screen</span></h1>

    <div id="banner"></div>

    <div class="section">
      <div class="row"><strong>Device</strong></div>
      <div class="row">
        <select id="device">
          <option value="iphone" selected>iPhone 16 Pro Max (GLB)</option>
        </select>
      </div>
      <div class="row">
        <button id="reloadModel" class="btn secondary">Force refresh model</button>
      </div>
      <div class="hint">Loads from <code class="small">iphone-15-pro/source/apple_iphone_15_pro_max_black(2).glb</code></div>
    </div>

    <div class="section">
      <div class="row"><strong>Screen Texture</strong></div>
      <div class="row">
        <select id="materialSelect"><option value="">(loading…)</option></select>
        <select id="slotSelect">
          <option value="auto" selected>Auto (base+emissive)</option>
          <option value="base">Base color</option>
          <option value="emissive">Emissive</option>
        </select>
      </div>
      <div class="row">
        <button id="autoPick" class="btn secondary">Auto-detect screen</button>
        <button id="applyToSelected" class="btn secondary">Apply to selected</button>
      </div>
      <div class="row">
        <button id="chooseImage" class="btn">Choose Image…</button>
        <input id="imageInput" type="file" accept="image/*" style="display:none">
        <label style="font-size:12px"><input type="checkbox" id="emissiveOn" checked> Make it bright (emissive)</label>
        <button id="clearImage" class="btn secondary" disabled>Clear</button>
      </div>
      <div class="hint">Target: <code id="targetLabel" class="small">(none)</code></div>
    </div>

    <div class="section">
      <div class="row"><strong>Orientation & Padding</strong></div>
      <div class="row" style="width:100%">
        <div style="flex:1"><div class="hint">Rotate X (°)</div><input id="rx" type="range" min="-60" max="60" step="15" value="0"></div>
        <div style="width:44px;text-align:right" id="rxVal">0°</div>
      </div>
      <div class="row" style="width:100%">
        <div style="flex:1"><div class="hint">Rotate Y (°)</div><input id="ry" type="range" min="-60" max="60" step="15" value="0"></div>
        <div style="width:44px;text-align:right" id="ryVal">0°</div>
      </div>
      <div class="row" style="width:100%">
        <div style="flex:1"><div class="hint">Padding</div><input id="pad" type="range" min="0" max="220" step="2" value="36"></div>
        <div style="width:64px;text-align:right" id="padVal">36px</div>
      </div>
      <div class="row"><button id="frontBtn" class="btn secondary">Front-on</button><button id="tiltBtn" class="btn secondary">Tilted</button><button id="resetBtn" class="btn secondary">Reset</button></div>
    </div>

    <div class="section">
      <div class="row"><strong>Export</strong></div>
      <div class="hint">Exports an exact 720×720 PNG.</div>
      <button id="exportBtn" class="btn">Export PNG</button>
    </div>
  </aside>

  <main>
    <div class="toolbar">
      <div class="hint">Preview (exact 720×720 export)</div>
    </div>
    <div class="stage-outer">
      <div class="stage">
        <model-viewer id="mv" camera-controls environment-image="neutral" exposure="1.0"
          autoplay shadow-intensity="0" ar-modes="" disable-tap interaction-prompt="none" tone-mapping="neutral">
        </model-viewer>
      </div>
    </div>
  </main>

<script type="module">
const mv = document.getElementById('mv');
const matSelect = document.getElementById('materialSelect');
const slotSelect = document.getElementById('slotSelect');
const autoBtn = document.getElementById('autoPick');
const applyBtn = document.getElementById('applyToSelected');
const chooseImage = document.getElementById('chooseImage');
const imageInput = document.getElementById('imageInput');
const emissiveOn = document.getElementById('emissiveOn');
const clearImage = document.getElementById('clearImage');
const targetLabel = document.getElementById('targetLabel');
const banner = document.getElementById('banner');
const rx = document.getElementById('rx'), ry=document.getElementById('ry'), rxVal=document.getElementById('rxVal'), ryVal=document.getElementById('ryVal');
const pad = document.getElementById('pad'), padVal=document.getElementById('padVal');

const IPHONE_GLB = 'iphone-15-pro/source/apple_iphone_15_pro_max_black(2).glb';

let target = null; // {material, slot: 'base'|'emissive'|'auto'}

// ---------- helpers
function showBanner(msg){ banner.textContent = msg; banner.style.display = 'block'; }
function hideBanner(){ banner.style.display = 'none'; }

function texNameOrUrl(tex){
  return tex?.source?.name || tex?.source?.uri || tex?.image?.currentSrc || tex?.image?.src || '';
}
function texSize(tex){
  const w = tex?.source?.width || tex?.image?.naturalWidth || tex?.image?.width || 0;
  const h = tex?.source?.height|| tex?.image?.naturalHeight|| tex?.image?.height|| 0;
  return {w,h,area:w*h,aspect: w&&h ? w/h : 0};
}
function listMaterials(){
  const mats = mv.model?.materials || [];
  console.group(`materials (${mats.length})`);
  mats.forEach((m,i)=>{
    const bc = m.pbrMetallicRoughness.baseColorTexture?.texture;
    const em = m.emissiveTexture?.texture;
    console.log(`#${i} ${m.name}`, {
      base: texNameOrUrl(bc),
      baseSize: texSize(bc),
      emissive: texNameOrUrl(em),
      emissiveSize: texSize(em)
    });
  });
  console.groupEnd();
}

function populateMaterials(){
  const mats = mv.model?.materials || [];
  matSelect.innerHTML = '';
  if(!mats.length){
    const opt = document.createElement('option');
    opt.value = ''; opt.textContent = '(no materials found)';
    matSelect.appendChild(opt);
    showBanner('No materials were exposed by the model yet. If this persists, try Force refresh.');
    return;
  }
  hideBanner();
  const first = document.createElement('option'); first.value=''; first.textContent='— choose material —';
  matSelect.appendChild(first);
  for(const m of mats){
    const opt = document.createElement('option');
    opt.value = m.name;
    opt.textContent = m.name || '(unnamed)';
    matSelect.appendChild(opt);
  }
}

function pickLargestPortraitTexture(){
  // Heuristic: choose the material/slot whose texture is tall>wide and has the largest pixel area.
  let best = null;
  const mats = mv.model?.materials || [];
  for(const m of mats){
    const base = m.pbrMetallicRoughness.baseColorTexture?.texture;
    const emis = m.emissiveTexture?.texture;
    const candidates = [{slot:'base', tex:base},{slot:'emissive', tex:emis}];
    for(const c of candidates){
      if(!c.tex) continue;
      const {w,h,area} = texSize(c.tex);
      if(h <= w || area === 0) continue; // portrait only
      if(!best || area > best.area) best = {material:m, slot:c.slot, area, url:texNameOrUrl(c.tex)};
    }
  }
  return best;
}

function setTarget(t){
  target = t || null;
  targetLabel.textContent = target ? `${target.material.name} (${target.slot})` : '(none)';
  if(target){
    // reflect in UI
    matSelect.value = target.material.name || '';
    slotSelect.value = target.slot === 'base' || target.slot === 'emissive' ? target.slot : 'auto';
  }
}

// ---------- camera controls
function applyCamera(){
  const theta = parseInt(ry.value,10)||0;
  const phi = 90 - (parseInt(rx.value,10)||0);
  const radius = 2.6 + (parseInt(pad.value,10)||0) * 0.006;
  mv.cameraOrbit = `${theta}deg ${phi}deg ${radius}m`;
  rxVal.textContent = `${rx.value}°`; ryVal.textContent = `${ry.value}°`; padVal.textContent = `${pad.value}px`;
}
[rx,ry,pad].forEach(el=> el.addEventListener('input', applyCamera));
document.getElementById('frontBtn').addEventListener('click', ()=>{ rx.value=0; ry.value=0; applyCamera(); });
document.getElementById('tiltBtn').addEventListener('click', ()=>{ rx.value=-12; ry.value=-24; applyCamera(); });
document.getElementById('resetBtn').addEventListener('click', ()=>{ rx.value=0; ry.value=0; pad.value=36; applyCamera(); });

// ---------- model load & readiness
mv.addEventListener('scene-graph-ready', ()=>{
  populateMaterials();
  listMaterials();
  const best = pickLargestPortraitTexture();
  if(best){ setTarget(best); }
});
mv.addEventListener('load', ()=>{ /* extra safety if some models only expose on load */ 
  if(!mv.model) return;
  if(!matSelect.options.length) populateMaterials();
});

// ---------- actions
document.getElementById('reloadModel').addEventListener('click', ()=>{
  // cache-bust the GLB so textures/cdn refresh
  mv.src = `${IPHONE_GLB}?v=${Date.now()}`;
});

autoBtn.addEventListener('click', ()=>{
  const best = pickLargestPortraitTexture();
  setTarget(best);
});
applyBtn.addEventListener('click', ()=>{
  const name = matSelect.value;
  if(!name) return;
  const mats = mv.model?.materials || [];
  const m = mats.find(mm => mm.name === name);
  if(!m){ showBanner('Selected material not found on model.'); return; }
  setTarget({material:m, slot: slotSelect.value === 'auto' ? 'base' : slotSelect.value});
});

chooseImage.addEventListener('click', ()=> imageInput.click());

imageInput.addEventListener('change', async ()=>{
  const f = imageInput.files[0]; if(!f) return;
  if(!target){ showBanner('No target yet. Click “Auto-detect screen” or pick a material.'); return; }
  hideBanner();
  const tex = await mv.createTexture(URL.createObjectURL(f));
  // Always set base; optionally set emissive for brightness
  if(target.slot !== 'emissive'){
    target.material.pbrMetallicRoughness.setBaseColorFactor([1,1,1,1]);
    target.material.pbrMetallicRoughness.setBaseColorTexture(tex);
  }
  if(emissiveOn.checked && target.slot !== 'base'){
    target.material.setEmissiveTexture(tex);
    target.material.setEmissiveFactor([1,1,1]);
  }
  target.material.pbrMetallicRoughness.metallicFactor = 0.0;
  target.material.pbrMetallicRoughness.roughnessFactor = 0.9;
  target.material.alphaMode = 'OPAQUE';
  clearImage.disabled = false;
});

clearImage.addEventListener('click', ()=>{
  if(!target) return;
  target.material.pbrMetallicRoughness.baseColorTexture?.setTexture(null);
  target.material.setEmissiveTexture(null);
  target.material.setEmissiveFactor([0,0,0]);
  clearImage.disabled = true;
});

// ---------- export (exact 720×720)
document.getElementById('exportBtn').addEventListener('click', async ()=>{
  try{
    await mv.updateComplete;
    const blob = await mv.toBlob({mimeType:'image/png', quality:1, idealAspect:1});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'mockup-720.png'; a.click();
  }catch(e){ showBanner('Export failed. Try a Chromium browser.'); console.error(e); }
});

// ---------- init
applyCamera();
mv.src = `${IPHONE_GLB}?v=${Date.now()}`; // first load with cache-bust
</script>
</body>
</html>
