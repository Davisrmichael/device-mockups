<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mockup Maker — model‑viewer (URL‑match build)</title>
<script type="module" src="https://unpkg.com/@google/model-viewer@3.3.0/dist/model-viewer.min.js"></script>
<style>
  :root{ --bg:#e9edf1; --panel:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --btn:#111827; --radius:16px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink);
       display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06);
         padding:16px;display:flex;flex-direction:column;gap:16px;height:calc(100vh - 32px);position:sticky;top:16px}
  h1{font-size:18px;margin:0;display:flex;gap:8px;align-items:center}
  .pill{font-size:12px;background:#e0ecff;color:#2563eb;padding:4px 8px;border-radius:999px;font-weight:700}
  .section{border-top:1px solid var(--line);padding-top:12px;margin-top:4px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:none;border-radius:10px;padding:10px 12px;background:var(--btn);color:#fff;font-weight:700;cursor:pointer}
  .btn.secondary{background:#e5e7eb;color:#111827}
  .hint{font-size:12px;color:var(--muted)}
  .stage-outer{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px;display:flex;justify-content:center}
  .stage{width:720px;height:720px;border-radius:12px;overflow:hidden;position:relative;background:#e5e7eb;display:flex;align-items:center;justify-content:center}
  model-viewer{width:720px;height:720px;--poster-color: transparent;}
  .toolbar{display:flex;justify-content:space-between;align-items:center}
  code.small{font-size:11px}
</style>
</head>
<body>
  <aside class="panel">
    <h1>Mockup Maker <span class="pill">url‑match</span></h1>
    <div class="section"><div class="hint">Loads: <code class="small">iphone-15-pro/source/apple_iphone_15_pro_max_black(2).glb</code></div></div>
    <div class="section">
      <div class="row"><strong>Screen</strong></div>
      <div class="row">
        <button id="chooseImage" class="btn">Choose Screenshot…</button>
        <input id="imageInput" type="file" accept="image/*" style="display:none">
        <button id="clearImage" class="btn secondary" disabled>Clear</button>
      </div>
      <div class="hint">Targets texture whose URL contains <code>iphone-15-pro/textures/gltf_embedded_18.png</code>.
        If not found, falls back to largest texture on the model.</div>
      <div class="hint">Target: <code id="targetLabel" class="small">(detecting…)</code></div>
    </div>
    <div class="section">
      <div class="row"><strong>Orientation & Padding</strong></div>
      <div class="row" style="width:100%"><div style="flex:1"><div class="hint">Rotate X (°)</div><input id="rx" type="range" min="-60" max="60" step="15" value="0"></div><div style="width:44px;text-align:right" id="rxVal">0°</div></div>
      <div class="row" style="width:100%"><div style="flex:1"><div class="hint">Rotate Y (°)</div><input id="ry" type="range" min="-60" max="60" step="15" value="0"></div><div style="width:44px;text-align:right" id="ryVal">0°</div></div>
      <div class="row" style="width:100%"><div style="flex:1"><div class="hint">Padding</div><input id="pad" type="range" min="0" max="220" step="2" value="36"></div><div style="width:64px;text-align:right" id="padVal">36px</div></div>
      <div class="row"><button id="frontBtn" class="btn secondary">Front‑on</button><button id="tiltBtn" class="btn secondary">Tilted</button><button id="resetBtn" class="btn secondary">Reset</button></div>
    </div>
    <div class="section">
      <div class="row"><strong>Export</strong></div>
      <div class="hint">Exports an exact 720×720 PNG.</div>
      <button id="exportBtn" class="btn">Export PNG</button>
    </div>
  </aside>

  <main>
    <div class="toolbar"><div class="hint">Preview (exact 720×720 export)</div></div>
    <div class="stage-outer">
      <div class="stage">
        <model-viewer id="mv" camera-controls environment-image="neutral" exposure="1.0" autoplay shadow-intensity="0" ar-modes=""
          disable-tap interaction-prompt="none" tone-mapping="neutral"></model-viewer>
      </div>
    </div>
  </main>

<script type="module">
const mv = document.getElementById('mv');
const chooseImage = document.getElementById('chooseImage');
const imageInput = document.getElementById('imageInput');
const clearImage = document.getElementById('clearImage');
const rx = document.getElementById('rx'), ry=document.getElementById('ry'), rxVal=document.getElementById('rxVal'), ryVal=document.getElementById('ryVal');
const pad = document.getElementById('pad'), padVal=document.getElementById('padVal');
const targetLabel = document.getElementById('targetLabel');

const GLB_PATH = 'iphone-15-pro/source/apple_iphone_15_pro_max_black(2).glb';
const SCREEN_URL_SUB = 'iphone-15-pro/textures/gltf_embedded_18.png';

let screenTarget = null;

function texNameOrUrl(tex){
  // Try a bunch of places where model-viewer/three may stash it
  return tex?.source?.name || tex?.source?.uri || tex?.source?.src || tex?.image?.currentSrc || tex?.image?.src || '';
}
function texArea(tex){
  const w = tex?.source?.width || tex?.image?.width || 0;
  const h = tex?.source?.height || tex?.image?.height || 0;
  return w*h;
}
function slotInfo(m){
  const base = m.pbrMetallicRoughness.baseColorTexture?.texture;
  const emis = m.emissiveTexture?.texture;
  return {
    base, emis,
    baseStr: texNameOrUrl(base),
    emisStr: texNameOrUrl(emis),
    baseSize: texArea(base),
    emisSize: texArea(emis)
  };
}
function pickTarget(){
  const mats = mv.model?.materials || [];
  // 1) URL/filename contains the exact path piece
  for(const m of mats){
    const s = slotInfo(m);
    if((s.baseStr||'').includes(SCREEN_URL_SUB)) return {material:m, slot:'base'};
    if((s.emisStr||'').includes(SCREEN_URL_SUB)) return {material:m, slot:'emissive'};
  }
  // 2) Fallback: largest texture
  let best=null;
  for(const m of mats){
    const s = slotInfo(m);
    if(s.base && s.baseSize > (best?.size||0)) best={material:m, slot:'base', size:s.baseSize};
    if(s.emis && s.emisSize > (best?.size||0)) best={material:m, slot:'emissive', size:s.emisSize};
  }
  return best && {material:best.material, slot:best.slot};
}
function label(){
  if(!screenTarget){ targetLabel.textContent='(not found yet)'; return; }
  const m=screenTarget.material, slot=screenTarget.slot;
  const tex = slot==='base' ? m.pbrMetallicRoughness.baseColorTexture?.texture
                            : m.emissiveTexture?.texture;
  targetLabel.textContent = `${m.name||'(unnamed)'} — ${slot} — ${texNameOrUrl(tex)}`;
}
function applyCamera(){
  const theta = parseInt(ry.value,10)||0;
  const phi = 90 - (parseInt(rx.value,10)||0);
  const radius = 2.6 + (parseInt(pad.value,10)||0) * 0.006;
  mv.cameraOrbit = `${theta}deg ${phi}deg ${radius}m`;
  rxVal.textContent = `${rx.value}°`; ryVal.textContent = `${ry.value}°`; padVal.textContent = `${pad.value}px`;
}
[rx,ry,pad].forEach(el=> el.addEventListener('input', applyCamera));
document.getElementById('frontBtn').addEventListener('click', ()=>{ rx.value=0; ry.value=0; applyCamera(); });
document.getElementById('tiltBtn').addEventListener('click', ()=>{ rx.value=-12; ry.value=-24; applyCamera(); });
document.getElementById('resetBtn').addEventListener('click', ()=>{ rx.value=0; ry.value=0; pad.value=36; applyCamera(); });

mv.addEventListener('load', ()=>{
  screenTarget = pickTarget();
  label();
  console.log('Picked screen target:', screenTarget);
});

chooseImage.addEventListener('click', ()=> imageInput.click());
imageInput.addEventListener('change', async ()=>{
  const f = imageInput.files[0]; if(!f) return;
  if(!screenTarget){
    screenTarget = pickTarget();
    if(!screenTarget){ alert('No screen material found.'); return; }
  }
  const tex = await mv.createTexture(URL.createObjectURL(f));
  const m = screenTarget.material;
  if(screenTarget.slot === 'emissive'){
    m.setEmissiveTexture(tex);
    m.setEmissiveFactor([1,1,1]);
  }else{
    m.pbrMetallicRoughness.setBaseColorFactor([1,1,1,1]);
    m.pbrMetallicRoughness.setBaseColorTexture(tex);
  }
  m.pbrMetallicRoughness.metallicFactor = 0.0;
  m.pbrMetallicRoughness.roughnessFactor = 0.9;
  clearImage.disabled = true; // keep UI simpler
  label();
});

document.getElementById('exportBtn').addEventListener('click', async ()=>{
  await mv.updateComplete;
  const blob = await mv.toBlob({mimeType:'image/png', quality:1.0, idealAspect:1});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'mockup-720.png';
  a.click();
});

applyCamera();
mv.src = GLB_PATH;
</script>
</body>
</html>
