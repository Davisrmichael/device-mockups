<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iPhone 15 Pro Mockup</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    body {
      margin: 0;
      display: flex;
      font-family: sans-serif;
      height: 100vh;
      overflow: hidden;
    }
    #controls {
      background: #f4f4f4;
      padding: 1rem;
      width: 250px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    model-viewer {
      flex: 1;
      background: #ddd;
    }
    #error {
      color: red;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div id="controls">
    <h3>Controls</h3>
    <input type="file" id="fileInput" accept="image/*" />
    <div id="error"></div>
  </div>

  <model-viewer id="mv"
    src="iPhone-15-pro-2/iPhone-15.gltf"
    camera-controls
    environment-image="neutral"
    shadow-intensity="1"
    style="width: 100%; height: 100%;">
  </model-viewer>

  <script type="module">
    const mv = document.querySelector('#mv');
    const fileInput = document.querySelector('#fileInput');
    const errorBox = document.querySelector('#error');

    async function applyImageToScreen(img) {
      try {
        errorBox.textContent = "";

        // Ensure model is loaded
        await mv.updateComplete;

        // Find the "Screen" material
        const mat = mv.model?.materials.find(m => m.name === 'Screen');
        if (!mat) {
          throw new Error("Screen material not found in model");
        }

        // Create a canvas to auto-scale image
        const canvas = document.createElement('canvas');
        const size = 1024; // texture resolution
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = "#000";
        ctx.fillRect(0, 0, size, size);

        // Draw image scaled to fit
        const scale = Math.min(size / img.width, size / img.height);
        const x = (size / 2) - (img.width * scale / 2);
        const y = (size / 2) - (img.height * scale / 2);
        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);

        // Create texture from canvas
        const tex = await mv.createTexture(canvas);

        // Apply to base color
        const bc = mat.pbrMetallicRoughness.baseColorTexture;
        if (bc && typeof bc.setTexture === 'function') {
          bc.setTexture(tex);
        }

        // Apply to emissive
        if (mat.emissiveTexture && typeof mat.emissiveTexture.setTexture === 'function') {
          mat.emissiveTexture.setTexture(tex);
        } else if (typeof mat.setEmissiveTexture === 'function') {
          mat.setEmissiveTexture(tex);
        }

        // White base so colors pop
        mat.pbrMetallicRoughness.setBaseColorFactor([1,1,1,1]);

        // Matte finish
        if (typeof mat.pbrMetallicRoughness.setMetallicFactor === 'function') {
          mat.pbrMetallicRoughness.setMetallicFactor(0);
        }
        if (typeof mat.pbrMetallicRoughness.setRoughnessFactor === 'function') {
          mat.pbrMetallicRoughness.setRoughnessFactor(0.9);
        }
      } catch (err) {
        console.error(err);
        errorBox.textContent = "Failed to apply image. Try another file / refresh.";
      }
    }

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const img = new Image();
      img.onload = () => applyImageToScreen(img);
      img.onerror = () => {
        errorBox.textContent = "Invalid image file.";
      };
      img.src = URL.createObjectURL(file);
    });
  </script>
</body>
</html>
