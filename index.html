<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mockup Maker — iPhone • model-viewer</title>
<script type="module" src="https://unpkg.com/@google/model-viewer@3.3.0/dist/model-viewer.min.js"></script>
<style>
  :root{--bg:#eef1f5;--panel:#fff;--ink:#0f172a;--muted:#64748b;--line:#e5e7eb;--btn:#111827;--radius:14px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.35 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);height:calc(100vh - 32px);position:sticky;top:16px;display:flex;flex-direction:column;gap:16px}
  h1{margin:0 0 4px;font-size:18px}
  .hint{color:var(--muted);font-size:12px}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .section{border-top:1px solid var(--line);padding-top:12px}
  .btn{appearance:none;border:0;border-radius:10px;padding:10px 12px;background:var(--btn);color:#fff;font-weight:700;cursor:pointer}
  .btn.secondary{background:#e5e7eb;color:#111827}
  input[type="range"]{width:100%}
  .stage-outer{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);display:flex;justify-content:center;align-items:center}
  .stage{width:720px;height:720px;border-radius:12px;overflow:hidden;background:#e5e7eb;display:flex;align-items:center;justify-content:center}
  model-viewer{width:720px;height:720px;--poster-color:transparent}
  .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.2);font-size:13px;opacity:0;pointer-events:none;transition:opacity .18s ease}
  .toast.show{opacity:1}
  .pill{font-size:12px;background:#e0ecff;color:#2563eb;padding:3px 8px;border-radius:999px;font-weight:700;margin-left:8px}
</style>
</head>
<body>
  <aside class="panel">
    <h1>Mockup Maker <span class="pill">iPhone • model-viewer</span></h1>

    <div class="section">
      <div class="row"><strong>Screen Texture</strong></div>
      <div class="row">
        <button id="chooseImage" class="btn">Choose Image…</button>
        <input id="imageInput" type="file" accept="image/*" style="display:none" />
        <label class="row" style="gap:6px;margin-left:6px">
          <input id="emissiveOn" type="checkbox" checked />
          <span class="hint">Bright (emissive)</span>
        </label>
        <button id="clearImage" class="btn secondary" disabled>Clear</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div style="flex:1">
          <div class="hint">Zoom</div>
          <input id="zoom" type="range" min="0.6" max="2.0" step="0.01" value="1.0" />
        </div>
        <div style="width:60px;text-align:right" class="hint" id="zoomVal">1.00×</div>
      </div>
      <div class="row">
        <div style="flex:1">
          <div class="hint">Pan X</div>
          <input id="panX" type="range" min="-1.0" max="1.0" step="0.01" value="0" />
        </div>
        <div style="width:60px;text-align:right" class="hint" id="panXVal">0.00</div>
      </div>
      <div class="row">
        <div style="flex:1">
          <div class="hint">Pan Y</div>
          <input id="panY" type="range" min="-1.0" max="1.0" step="0.01" value="0" />
        </div>
        <div style="width:60px;text-align:right" class="hint" id="panYVal">0.00</div>
      </div>
      <div class="hint">Targets material named <code>Screen</code>. Image is contained (fit) then panned.</div>
    </div>

    <div class="section">
      <div class="row"><strong>Orientation &amp; Padding</strong></div>
      <div class="row" style="width:100%">
        <div style="flex:1"><div class="hint">Rotate X (°)</div><input id="rx" type="range" min="-60" max="60" step="1" value="0" /></div>
        <div style="width:44px;text-align:right" class="hint" id="rxVal">0°</div>
      </div>
      <div class="row" style="width:100%">
        <div style="flex:1"><div class="hint">Rotate Y (°)</div><input id="ryUI" type="range" min="-60" max="60" step="1" value="0" /></div>
        <div style="width:44px;text-align:right" class="hint" id="ryVal">0°</div>
      </div>
      <div class="row" style="width:100%">
        <div style="flex:1"><div class="hint">Padding</div><input id="pad" type="range" min="0" max="220" step="2" value="36" /></div>
        <div style="width:64px;text-align:right" class="hint" id="padVal">36px</div>
      </div>
      <div class="row">
        <button id="frontBtn" class="btn secondary">Front-on</button>
        <button id="resetBtn" class="btn secondary">Reset</button>
      </div>
      <div class="hint">Front-on uses a hidden +180° yaw so the slider shows 0° but faces the screen.</div>
    </div>

    <div class="section">
      <div class="row"><strong>Export</strong></div>
      <div class="hint">Exports exact 720×720 PNG.</div>
      <button id="exportBtn" class="btn">Export PNG</button>
    </div>
  </aside>

  <main class="stage-outer">
    <div class="stage">
      <model-viewer id="mv"
        src="iPhone-15-pro-2/iPhone-15.gltf"
        camera-controls
        environment-image="neutral"
        exposure="1.0"
        shadow-intensity="0"
        ar-modes=""
        disable-tap
        interaction-prompt="none"
        tone-mapping="neutral">
      </model-viewer>
    </div>
  </main>

  <div id="toast" class="toast"></div>

<script type="module">
const mv = document.getElementById('mv');

// UI
const chooseImage = document.getElementById('chooseImage');
const imageInput  = document.getElementById('imageInput');
const emissiveOn  = document.getElementById('emissiveOn');
const clearBtn    = document.getElementById('clearImage');

const zoom  = document.getElementById('zoom');
const panX  = document.getElementById('panX');
const panY  = document.getElementById('panY');
const zoomVal = document.getElementById('zoomVal');
const panXVal = document.getElementById('panXVal');
const panYVal = document.getElementById('panYVal');

const rx = document.getElementById('rx'), rxVal = document.getElementById('rxVal');
const ryUI = document.getElementById('ryUI'), ryVal = document.getElementById('ryVal');
const pad = document.getElementById('pad'), padVal = document.getElementById('padVal');
const frontBtn = document.getElementById('frontBtn');
const resetBtn = document.getElementById('resetBtn');
const exportBtn = document.getElementById('exportBtn');
const toastEl = document.getElementById('toast');

// camera state (UI shows 0 but real yaw has +180° offset)
let yawOffset = 180;

function toast(msg, ms=1400){
  toastEl.textContent = msg;
  toastEl.classList.add('show');
  setTimeout(()=> toastEl.classList.remove('show'), ms);
}

// ===== Screen material helpers =====
function getScreenMaterial(){
  return mv.model?.materials?.find(m => (m.name||'') === 'Screen') || null;
}
function ensureWhiteBase(scr){
  scr.pbrMetallicRoughness.setBaseColorFactor([1,1,1,1]);
  scr.pbrMetallicRoughness.metallicFactor = 0.0;
  scr.pbrMetallicRoughness.roughnessFactor = 0.9;
}

// Offscreen canvas used for fitting/pan/zoom
const canvas = document.createElement('canvas');
canvas.width = 2048; canvas.height = 2048; // high-res texture source
const ctx = canvas.getContext('2d');

function drawToCanvas(img){
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0,0,W,H);
  // contain-fit image into canvas, then pan
  const iw = img.naturalWidth || img.width;
  const ih = img.naturalHeight || img.height;
  const canvasAR = W/H, imgAR = iw/ih;

  const z = parseFloat(zoom.value) || 1;
  let dw, dh;
  if (imgAR > canvasAR){
    // image is wider → fit width
    dw = W * z;
    dh = dw / imgAR;
  } else {
    // image is taller → fit height
    dh = H * z;
    dw = dh * imgAR;
  }
  const px = parseFloat(panX.value) || 0; // -1..1
  const py = parseFloat(panY.value) || 0; // -1..1
  const cx = W/2 + px * (W - dw)/2;
  const cy = H/2 + py * (H - dh)/2;

  ctx.fillStyle = '#000'; // black underlay
  ctx.fillRect(0,0,W,H);
  ctx.imageSmoothingQuality = 'high';
  ctx.drawImage(img, cx - dw/2, cy - dh/2, dw, dh);
}

// Current uploaded image element (kept to redraw when sliders move)
let currentImage = null;

// Apply canvas directly as texture (Option A)
async function applyCanvasToScreen(){
  const scr = getScreenMaterial();
  if (!scr){ toast('Screen material not found'); return false; }

  ensureWhiteBase(scr);

  const tex = await mv.createTexture(canvas); // <<<< Option A: pass canvas directly

  // Base-color slot (version-safe)
  const base = scr.pbrMetallicRoughness.baseColorTexture;
  if (base && typeof base.setTexture === 'function'){
    base.setTexture(tex);
  } else if (typeof scr.pbrMetallicRoughness.setBaseColorTexture === 'function'){
    scr.pbrMetallicRoughness.setBaseColorTexture(tex);
  }

  if (emissiveOn.checked){
    if (scr.emissiveTexture && typeof scr.emissiveTexture.setTexture === 'function'){
      scr.emissiveTexture.setTexture(tex);
    } else if (typeof scr.setEmissiveTexture === 'function'){
      scr.setEmissiveTexture(tex);
    }
    if (typeof scr.setEmissiveFactor === 'function') scr.setEmissiveFactor([1,1,1]);
    else scr.emissiveFactor = [1,1,1];
  } else {
    // turn emissive off
    if (scr.emissiveTexture?.setTexture) scr.emissiveTexture.setTexture(null);
    else if (typeof scr.setEmissiveTexture === 'function') scr.setEmissiveTexture(null);
    if (typeof scr.setEmissiveFactor === 'function') scr.setEmissiveFactor([0,0,0]);
    else scr.emissiveFactor = [0,0,0];
  }
  return true;
}

// Image upload flow
chooseImage.addEventListener('click', ()=> imageInput.click());
imageInput.addEventListener('change', ()=>{
  const f = imageInput.files?.[0]; if(!f) return;
  const img = new Image();
  img.onload = async () => {
    currentImage = img;
    drawToCanvas(img);
    try{
      await applyCanvasToScreen();
      clearBtn.disabled = false;
      toast('Screen updated');
    }catch(e){
      console.error(e);
      toast('Failed to apply image. Try another file / refresh.', 1800);
    }
  };
  img.onerror = ()=> toast('Could not read image');
  img.src = URL.createObjectURL(f);
});
clearBtn.addEventListener('click', async ()=>{
  const scr = getScreenMaterial(); if(!scr) return;
  // remove textures
  scr.pbrMetallicRoughness.baseColorTexture?.setTexture?.(null);
  if (scr.emissiveTexture?.setTexture) scr.emissiveTexture.setTexture(null);
  else scr.setEmissiveTexture?.(null);
  if (typeof scr.setEmissiveFactor === 'function') scr.setEmissiveFactor([0,0,0]); else scr.emissiveFactor=[0,0,0];
  clearBtn.disabled = true;
  currentImage = null;
});

// Redraw canvas & re-apply when sliders change
function onFitChange(){
  zoomVal.textContent = `${(+zoom.value).toFixed(2)}×`;
  panXVal.textContent = (+panX.value).toFixed(2);
  panYVal.textContent = (+panY.value).toFixed(2);
  if(!currentImage) return;
  drawToCanvas(currentImage);
  applyCanvasToScreen();
}
[zoom, panX, panY, emissiveOn].forEach(el => el.addEventListener('input', onFitChange));

// Camera handling
function applyCamera(){
  const theta = (parseInt(ryUI.value,10) || 0) + yawOffset; // hidden 180 offset
  const phi   = 90 - (parseInt(rx.value,10) || 0);
  const radius = 2.6 + (parseInt(pad.value,10) || 0) * 0.006;
  mv.cameraOrbit = `${theta}deg ${phi}deg ${radius}m`;
  rxVal.textContent  = `${rx.value}°`;
  ryVal.textContent  = `${ryUI.value}°`;
  padVal.textContent = `${pad.value}px`;
}
[rx, ryUI, pad].forEach(el => el.addEventListener('input', applyCamera));
frontBtn.addEventListener('click', ()=>{ rx.value=0; ryUI.value=0; applyCamera(); });
resetBtn.addEventListener('click', ()=>{ rx.value=0; ryUI.value=0; pad.value=36; applyCamera(); });

// Export 720×720
exportBtn.addEventListener('click', async ()=>{
  try{
    await mv.updateComplete;
    const blob = await mv.toBlob({mimeType:'image/png', quality:1, idealAspect:1});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'mockup-720.png';
    a.click();
  }catch(e){
    console.error(e);
    toast('Export failed. Try a Chromium browser.', 1800);
  }
});

// After model loads, confirm material exists
mv.addEventListener('load', ()=>{
  const scr = getScreenMaterial();
  if(!scr){
    toast('Tip: Material "Screen" not found in GLTF');
  }
  applyCamera(); // initial camera (front-on look with 0° UI)
});
</script>
</body>
</html>
