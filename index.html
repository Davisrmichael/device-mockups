<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mockup Maker — iPhone (model-viewer)</title>
<script type="module" src="https://unpkg.com/@google/model-viewer@3.3.0/dist/model-viewer.min.js"></script>
<style>
  :root{ --bg:#e9edf1; --panel:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb; --btn:#111827; --radius:16px; }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink);
       display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06);
         padding:16px;display:flex;flex-direction:column;gap:16px;height:calc(100vh - 32px);position:sticky;top:16px}
  h1{font-size:18px;margin:0;display:flex;gap:8px;align-items:center}
  .pill{font-size:12px;background:#e0ecff;color:#2563eb;padding:4px 8px;border-radius:999px;font-weight:700}
  .section{border-top:1px solid var(--line);padding-top:12px;margin-top:4px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{appearance:none;border:none;border-radius:10px;padding:10px 12px;background:var(--btn);color:#fff;font-weight:700;cursor:pointer}
  .btn.secondary{background:#e5e7eb;color:#111827}
  .hint{font-size:12px;color:var(--muted)}
  select,input[type="range"]{width:100%}
  .stage-outer{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 8px 24px rgba(0,0,0,.06);padding:16px;display:flex;justify-content:center}
  .stage{width:720px;height:720px;border-radius:12px;overflow:hidden;position:relative;background:#e5e7eb;display:flex;align-items:center;justify-content:center}
  model-viewer{width:720px;height:720px;--poster-color:transparent}
  .toolbar{display:flex;justify-content:space-between;align-items:center}
  code.small{font-size:11px}
</style>
</head>
<body>
  <aside class="panel">
    <h1>Mockup Maker <span class="pill">iPhone • model-viewer</span></h1>

    <div class="section">
      <div class="row"><strong>Device</strong></div>
      <div class="hint">
        Loads <code class="small">iphone-15-pro/source/apple_iphone_15_pro_max_black(2).glb</code> from this repo.
      </div>
    </div>

    <div class="section">
      <div class="row"><strong>Screen Texture</strong></div>
      <div class="row">
        <select id="materialSelect"><option value="">— choose material —</option></select>
        <button id="autoPick" class="btn secondary">Auto-detect screen</button>
      </div>
      <div class="row"><div class="hint">Texture target: <code id="texTarget" class="small">(auto)</code></div></div>
      <div class="row">
        <button id="chooseImage" class="btn">Choose Image…</button>
        <input id="imageInput" type="file" accept="image/*" style="display:none" />
        <label style="font-size:12px"><input type="checkbox" id="emissiveOn" checked /> Make it bright (emissive)</label>
        <button id="clearImage" class="btn secondary" disabled>Clear</button>
      </div>
    </div>

    <div class="section">
      <div class="row"><strong>Orientation & Padding</strong></div>
      <div class="row" style="width:100%">
        <div style="flex:1"><div class="hint">Rotate X (°)</div><input id="rx" type="range" min="-60" max="60" step="15" value="0" /></div>
        <div style="width:44px;text-align:right" id="rxVal">0°</div>
      </div>
      <div class="row" style="width:100%">
        <div style="flex:1"><div class="hint">Rotate Y (°)</div><input id="ry" type="range" min="-60" max="60" step="15" value="0" /></div>
        <div style="width:44px;text-align:right" id="ryVal">0°</div>
      </div>
      <div class="row" style="width:100%">
        <div style="flex:1"><div class="hint">Padding</div><input id="pad" type="range" min="0" max="220" step="2" value="36" /></div>
        <div style="width:64px;text-align:right" id="padVal">36px</div>
      </div>
      <div class="row">
        <button id="frontBtn" class="btn secondary">Front-on</button>
        <button id="tiltBtn" class="btn secondary">Tilted</button>
        <button id="resetBtn" class="btn secondary">Reset</button>
      </div>
    </div>

    <div class="section">
      <div class="row"><strong>Export</strong></div>
      <div class="hint">Exports an exact 720×720 PNG.</div>
      <button id="exportBtn" class="btn">Export PNG</button>
    </div>
  </aside>

  <main>
    <div class="toolbar"><div class="hint">Preview (exact 720×720 export)</div></div>
    <div class="stage-outer"><div class="stage">
      <model-viewer id="mv" camera-controls environment-image="neutral" exposure="1" autoplay shadow-intensity="0"
        ar-modes="" disable-tap interaction-prompt="none" tone-mapping="neutral"></model-viewer>
    </div></div>
  </main>

<script type="module">
const mv = document.getElementById('mv');
const matSelect = document.getElementById('materialSelect');
const autoBtn = document.getElementById('autoPick');
const chooseImage = document.getElementById('chooseImage');
const imageInput = document.getElementById('imageInput');
const emissiveOn = document.getElementById('emissiveOn');
const clearImage = document.getElementById('clearImage');
const rx = document.getElementById('rx'), ry=document.getElementById('ry');
const rxVal=document.getElementById('rxVal'), ryVal=document.getElementById('ryVal');
const pad = document.getElementById('pad'), padVal=document.getElementById('padVal');
const texTarget = document.getElementById('texTarget');

// NEW: add a Brute Apply button next to Clear (reuse your markup if you added one)
let bruteBtn = document.getElementById('bruteBtn');
if(!bruteBtn){
  bruteBtn = document.createElement('button');
  bruteBtn.id = 'bruteBtn';
  bruteBtn.className = 'btn secondary';
  bruteBtn.textContent = 'Brute Apply';
  clearImage.parentElement.insertBefore(bruteBtn, clearImage);
}

// GLB path + cache bust
const RAW_PATH = 'iphone-15-pro/source/apple_iphone_15_pro_max_black(2).glb';
const IPHONE_PATH = encodeURI(RAW_PATH) + '?v=' + Date.now();
mv.src = IPHONE_PATH;

// Error logging
mv.addEventListener('error', (e)=> console.error('model-viewer error:', e?.detail || e));

// Camera (UI shows 0°, engine gets +180° yaw)
function applyCamera(){
  const uiTheta = parseInt(ry.value,10)||0;
  const theta = (uiTheta + 180) % 360;
  const phi = 90 - (parseInt(rx.value,10)||0);
  const radius = 2.6 + (parseInt(pad.value,10)||0) * 0.006;
  mv.cameraOrbit = `${theta}deg ${phi}deg ${radius}m`;
  rxVal.textContent = `${rx.value}°`;
  ryVal.textContent = `${uiTheta}°`;
  padVal.textContent = `${pad.value}px`;
}
[rx,ry,pad].forEach(el=> el.addEventListener('input', applyCamera));
document.getElementById('frontBtn').addEventListener('click', ()=>{ rx.value=0; ry.value=0; applyCamera(); });
document.getElementById('tiltBtn').addEventListener('click', ()=>{ rx.value=-12; ry.value=-24; applyCamera(); });
document.getElementById('resetBtn').addEventListener('click', ()=>{ rx.value=0; ry.value=0; pad.value=36; applyCamera(); });
applyCamera();

let target = { material:null, slot:'base' };

function listMaterials(){
  const mats = mv.model?.materials || [];
  console.group(`Materials (${mats.length})`);
  mats.forEach((m,i)=>{
    const base = m.pbrMetallicRoughness.baseColorTexture?.texture?.source?.name;
    const emis = m.emissiveTexture?.texture?.source?.name;
    console.log(`#${i}`, m.name, { base, emissive: emis });
  });
  console.groupEnd();
  return mats;
}

function findByTextureName(sub){
  const mats = mv.model?.materials || [];
  for(const m of mats){
    const base = m.pbrMetallicRoughness.baseColorTexture?.texture?.source?.name || '';
    const emis = m.emissiveTexture?.texture?.source?.name || '';
    if(base.includes(sub)) return {material:m, slot:'base'};
    if(emis.includes(sub)) return {material:m, slot:'emissive'};
  }
  return null;
}

mv.addEventListener('load', async ()=>{
  await mv.updateComplete; // ensure model graph is ready
  const mats = listMaterials();
  // populate dropdown
  matSelect.innerHTML = '<option value="">— choose material —</option>';
  for(const m of mats){
    const opt = document.createElement('option');
    opt.value = m.name; opt.textContent = m.name || '(unnamed)';
    matSelect.appendChild(opt);
  }
  // try to lock onto the embedded screen file name
  const hit = findByTextureName('gltf_embedded_18');
  if(hit){
    target = hit;
    matSelect.value = target.material.name;
    texTarget.textContent = `gltf_embedded_18 (${target.slot})`;
  } else {
    texTarget.textContent = '(none detected)';
  }
});

autoBtn.addEventListener('click', ()=>{
  const mats = mv.model?.materials || [];
  const patterns = [/screen/i,/display/i,/glass/i,/island/i,/panel/i,/lcd|oled/i];
  const hit = mats.find(m=> patterns.some(p=> p.test(m.name||'')));
  if(hit){ matSelect.value = hit.name; target = {material:hit, slot:'base'}; texTarget.textContent = '(auto by name)'; }
});

// Create and apply a texture to a specific material
async function applyToTarget(file){
  const tex = await mv.createTexture(URL.createObjectURL(file));
  const mats = mv.model?.materials || [];
  if(matSelect.value){
    const chosen = mats.find(m=> m.name === matSelect.value);
    if(chosen) target.material = chosen;
  }
  if(!target.material) return false;

  target.material.pbrMetallicRoughness.setBaseColorFactor([1,1,1,1]);
  target.material.pbrMetallicRoughness.setBaseColorTexture(tex);
  if(emissiveOn.checked){
    target.material.setEmissiveTexture(tex);
    target.material.setEmissiveFactor([1,1,1]);
  }
  target.material.pbrMetallicRoughness.metallicFactor = 0;
  target.material.pbrMetallicRoughness.roughnessFactor = 0.9;
  target.material.alphaMode = 'OPAQUE';
  return true;
}

// BRUTE: apply to every material (base + emissive)
async function bruteApply(file){
  const tex = await mv.createTexture(URL.createObjectURL(file));
  const mats = mv.model?.materials || [];
  mats.forEach(m=>{
    m.pbrMetallicRoughness.setBaseColorFactor([1,1,1,1]);
    m.pbrMetallicRoughness.setBaseColorTexture(tex);
    if(emissiveOn.checked){
      m.setEmissiveTexture(tex);
      m.setEmissiveFactor([1,1,1]);
    } else {
      m.setEmissiveTexture(null);
      m.setEmissiveFactor([0,0,0]);
    }
    m.pbrMetallicRoughness.metallicFactor = 0;
    m.pbrMetallicRoughness.roughnessFactor = 0.9;
    m.alphaMode = 'OPAQUE';
  });
  clearImage.disabled = true; // everything got the screen; Clear becomes ambiguous
}

chooseImage.addEventListener('click', ()=> imageInput.click());

imageInput.addEventListener('change', async ()=>{
  const f = imageInput.files[0]; if(!f) return;
  const ok = await applyToTarget(f);
  if(!ok){
    // fallback if we still don’t have a target
    console.warn('No target material; try Brute Apply.');
    alert('No target material found yet. Try “Auto-detect screen” or use “Brute Apply”.');
  } else {
    clearImage.disabled = false;
  }
});

bruteBtn.addEventListener('click', async ()=>{
  const f = imageInput.files[0];
  if(!f){ alert('Choose an image first.'); return; }
  await bruteApply(f);
});

clearImage.addEventListener('click', ()=>{
  if(!target.material) return;
  target.material.pbrMetallicRoughness.baseColorTexture?.setTexture(null);
  target.material.setEmissiveTexture(null);
  target.material.setEmissiveFactor([0,0,0]);
  clearImage.disabled = true;
});
</script>

</body>
</html>
